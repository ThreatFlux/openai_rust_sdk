#!/bin/bash
# Pre-commit hook for openai_rust_sdk
# Runs format check and strict linting before allowing commits
# Install with: make install-hooks

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}Running pre-commit checks...${NC}"

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo -e "${RED}Error: Not in project root directory${NC}"
    exit 1
fi

# Run format check
echo -e "${CYAN}Checking code formatting...${NC}"
if ! cargo fmt --check 2>/dev/null; then
    echo -e "${RED}Error: Code is not formatted. Run 'cargo fmt' or 'make fmt' first.${NC}"
    exit 1
fi
echo -e "${GREEN}Format check passed${NC}"

# Run strict clippy linting
echo -e "${CYAN}Running strict clippy linting...${NC}"
if ! cargo clippy --all-features --all-targets -- \
    -D warnings \
    -D clippy::all \
    -D clippy::pedantic \
    -D clippy::nursery \
    -D clippy::cargo \
    -A clippy::module_name_repetitions \
    -A clippy::missing_errors_doc \
    -A clippy::missing_panics_doc \
    -A clippy::must_use_candidate \
    -A clippy::multiple_crate_versions 2>/dev/null; then
    echo -e "${RED}Error: Clippy found issues. Fix them before committing.${NC}"
    echo -e "${YELLOW}Run 'make lint' to see detailed errors.${NC}"
    exit 1
fi
echo -e "${GREEN}Clippy check passed${NC}"

# Run tests (quick check - can be skipped with --no-verify if needed)
echo -e "${CYAN}Running quick test check...${NC}"
if ! cargo test --lib --quiet 2>/dev/null; then
    echo -e "${RED}Error: Tests failed. Fix them before committing.${NC}"
    echo -e "${YELLOW}Run 'make test' to see detailed errors.${NC}"
    exit 1
fi
echo -e "${GREEN}Tests passed${NC}"

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
